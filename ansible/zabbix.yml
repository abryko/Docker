---
#
##
### Written by the CAT (Cloudwatt Automation Team)
##
#
- hosts: servers
  user: cloud
  become: yes

  vars:
    package: zabbix
    server_ip: server_ip
    toolbox_adress: toolbox_adress
    openstack_id: openstack_id

  tasks:
<<<<<<< HEAD

    - name: Add repository
      yumrepo:
      name: zabbix-repo
      description: Zabbix Yum REPO
      baseurl: http://repo.zabbix.com/zabbix/2.2/rhel/7/x86_64/zabbix-release-2.2-1.el7.noarch.rpm
      When: {{ansible_distribution}}=Centos



=======
>>>>>>> f166bf952e293b7f0b07856006c33a6240dd6f4b
    - name: install packages
      package: name={{ item }} state=present
      with_items:
        - zabbix-agent
        - ntp
      notify: restart ntp

    - name: get zabbix_server IP
      lineinfile:
        name=/etc/zabbix/zabbix_agentd.conf
        regexp=".*ServerActive=.*"
        line="ServerActive={{ toolbox_address }}"

    - name: zabbix slave hostname
      lineinfile:
        name=/etc/zabbix/zabbix_agentd.conf
        regexp="^Hostname="
        line="Hostname={{ ansible_hostname }}"
      notify: restart zabbix

    - name : install httplib2
      pip: name=httplib2
            state=present

    - uri:
        url: http://{{ toolbox_address }}:2379/v2/keys/servers/{{ openstack_id }}/apps/zabbix
        method: PUT
        HEADER_Content-Type: "application/x-www-form-urlencoded"
        status_code: 200,201
        body_format: raw
        body: "value={{ package }}"




  handlers:
    - name: restart ntp
      service:
        name=ntp
        state=restarted
        enabled=yes

    - name: restart zabbix
      service:
        name=zabbix-agent
        state=restarted
        enabled=yes





